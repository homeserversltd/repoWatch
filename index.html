<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code History</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border-color: #30363d;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 8px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            width: 300px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 20px;
            min-width: 150px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        .sidebar {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-list {
            list-style: none;
        }

        .project-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            transition: background-color 0.15s;
        }

        .project-item:hover {
            background-color: var(--bg-tertiary);
        }

        .project-item.active {
            background-color: var(--bg-tertiary);
            border-left: 3px solid var(--accent-blue);
            padding-left: 9px;
        }

        .project-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-count {
            font-size: 12px;
            color: var(--text-muted);
            background-color: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .content-area {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 600px;
        }

        .content-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 20px;
            font-weight: 600;
        }

        .github-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .github-link:hover {
            color: var(--accent-blue);
        }

        .timeline {
            padding: 20px;
        }

        .day-group {
            margin-bottom: 30px;
        }

        .day-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .day-date {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .day-summary {
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .session-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .session-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .session-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .badge.commit {
            background-color: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .session-summary {
            font-size: 14px;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .session-summary ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .session-summary li {
            margin-bottom: 4px;
        }

        .commits-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .commits-title {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .commit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        .commit-sha {
            font-family: ui-monospace, SFMono-Regular, "SF Mono", monospace;
            font-size: 12px;
            color: var(--accent-blue);
            text-decoration: none;
        }

        .commit-sha:hover {
            text-decoration: underline;
        }

        .commit-tag {
            font-size: 12px;
            color: var(--accent-green);
            text-decoration: none;
            background-color: rgba(63, 185, 80, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .commit-tag:hover {
            background-color: rgba(63, 185, 80, 0.25);
        }

        .tag-icon {
            font-size: 11px;
        }

        .commit-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tools-list {
            margin-top: 12px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tool-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
        }

        .badge.clickable {
            cursor: pointer;
            transition: all 0.15s;
        }

        .badge.clickable:hover {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
        }

        .badge.clickable.expanded {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
        }

        .messages-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: none;
        }

        .messages-list.expanded {
            display: block;
        }

        .messages-title {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .message-content {
            font-size: 13px;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .filter-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .highlight {
            background-color: rgba(210, 153, 34, 0.3);
            border-radius: 2px;
            padding: 0 2px;
        }

        /* Beads styles */
        .beads-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-orange);
        }

        .beads-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .beads-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .beads-icon {
            font-size: 18px;
        }

        .beads-stats-mini {
            display: flex;
            gap: 12px;
        }

        .beads-stat-mini {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .beads-stat-mini strong {
            color: var(--accent-orange);
        }

        .beads-content {
            display: none;
        }

        .beads-content.expanded {
            display: block;
        }

        .beads-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .beads-filter-btn {
            padding: 4px 12px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .beads-filter-btn:hover {
            border-color: var(--accent-orange);
        }

        .beads-filter-btn.active {
            background: var(--accent-orange);
            color: var(--bg-primary);
            border-color: var(--accent-orange);
        }

        .beads-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .bead-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--text-muted);
        }

        .bead-item.priority-1 {
            border-left-color: #f85149;
        }

        .bead-item.priority-2 {
            border-left-color: var(--accent-orange);
        }

        .bead-item.priority-3 {
            border-left-color: var(--accent-blue);
        }

        .bead-item.status-closed {
            opacity: 0.6;
        }

        .bead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .bead-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .bead-id {
            font-size: 11px;
            font-family: ui-monospace, SFMono-Regular, "SF Mono", monospace;
            color: var(--text-muted);
        }

        .bead-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bead-type {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .bead-type.bug {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }

        .bead-type.feature {
            background: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
        }

        .bead-type.task {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent-blue);
        }

        .bead-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .bead-status.open {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .bead-status.closed {
            background: rgba(139, 148, 158, 0.15);
            color: var(--text-muted);
        }

        .bead-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .bead-close-reason {
            font-size: 12px;
            color: var(--accent-green);
            margin-top: 8px;
            padding: 8px;
            background: rgba(63, 185, 80, 0.1);
            border-radius: 4px;
        }

        .beads-toggle {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .beads-header.expanded .beads-toggle {
            transform: rotate(180deg);
        }

        /* Suggestions styles */
        .suggestions-tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            margin-right: 4px;
            transition: all 0.15s;
        }

        .suggestions-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .suggestions-tab.active {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
        }

        .tabs-container {
            display: flex;
            margin-bottom: -1px;
            position: relative;
            z-index: 1;
        }

        .suggestions-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0 8px 8px 8px;
            padding: 20px;
            display: none;
        }

        .suggestions-panel.active {
            display: block;
        }

        /* Live Monitor Styles */
        .live-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0 8px 8px 8px;
            padding: 20px;
            display: none;
        }

        .live-panel.active {
            display: block;
        }

        .live-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .live-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .live-indicator.warning {
            background: var(--accent-orange);
        }

        .live-indicator.alert {
            background: #f85149;
            animation: pulse-alert 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .live-settings-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-settings-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .live-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .live-stat {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 120px;
        }

        .live-stat-value {
            font-size: 24px;
            font-weight: 600;
        }

        .live-stat-value.waiting {
            color: var(--accent-orange);
        }

        .live-stat-value.processing {
            color: var(--accent-blue);
        }

        .live-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .live-alert-banner {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
        }

        .live-alert-banner.active {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .live-alert-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-alert-icon {
            font-size: 20px;
        }

        .live-alert-text {
            color: #f85149;
            font-weight: 500;
        }

        .live-alert-dismiss {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
        }

        .live-sessions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .live-session-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            transition: border-color 0.15s;
        }

        .live-session-card:hover {
            border-color: var(--text-muted);
        }

        .live-session-card.waiting {
            border-left: 3px solid var(--accent-orange);
        }

        .live-session-card.processing {
            border-left: 3px solid var(--accent-blue);
        }

        .live-session-card.idle {
            border-left: 3px solid var(--text-muted);
            opacity: 0.7;
        }

        .live-session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .live-session-project {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-session-state {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .live-session-state.waiting {
            background: rgba(210, 153, 34, 0.2);
            color: var(--accent-orange);
        }

        .live-session-state.processing {
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent-blue);
        }

        .live-session-state.idle {
            background: var(--bg-secondary);
            color: var(--text-muted);
        }

        .live-session-state.complete {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }

        .live-session-details {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .live-session-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .live-session-preview {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-muted);
            font-style: italic;
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .live-session-approval {
            margin-top: 10px;
            padding: 10px;
            background: rgba(210, 153, 34, 0.1);
            border-radius: 6px;
            font-size: 13px;
        }

        .live-session-approval-label {
            color: var(--accent-orange);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .live-session-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .live-jump-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .live-jump-btn:hover {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .live-jump-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .live-jump-btn.success {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .live-jump-btn.error {
            background: #f85149;
            border-color: #f85149;
            color: white;
        }

        .live-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .live-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Notification Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
            padding: 0;
            line-height: 1;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .modal-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .modal-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .modal-slider-group {
            margin-top: 12px;
            margin-left: 28px;
        }

        .modal-slider-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .modal-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .modal-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-purple);
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .modal-btn-primary {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .modal-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-btn-test {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            margin-right: auto;
        }

        .suggestions-header {
            margin-bottom: 20px;
        }

        .suggestions-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestions-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .suggestion-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }

        .suggestion-card:hover {
            border-color: var(--accent-purple);
        }

        .suggestion-card.saved {
            opacity: 0.6;
            border-color: var(--accent-green);
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-purple);
        }

        .suggestion-save-btn {
            padding: 6px 12px;
            background: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .suggestion-save-btn:hover {
            background: #8b5cf6;
            transform: translateY(-1px);
        }

        .suggestion-save-btn:disabled {
            background: var(--accent-green);
            cursor: default;
            transform: none;
        }

        .suggestion-instruction {
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-purple);
            font-family: ui-monospace, SFMono-Regular, "SF Mono", monospace;
            white-space: pre-wrap;
        }

        .suggestion-rationale {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .suggestions-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .suggestions-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .claude-md-status {
            margin-top: 20px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .claude-md-path {
            font-family: ui-monospace, SFMono-Regular, "SF Mono", monospace;
            color: var(--accent-blue);
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: static;
            }
            .search-input {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo"></div>
                Claude Code History
            </h1>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search activities...">
                <div class="date-filter">
                    <span class="filter-label">From:</span>
                    <input type="date" class="date-input" id="dateFrom">
                    <span class="filter-label">To:</span>
                    <input type="date" class="date-input" id="dateTo">
                </div>
            </div>
        </header>

        <div class="stats" id="stats">
            <!-- Stats will be populated by JS -->
        </div>

        <div class="tabs-container">
            <button class="suggestions-tab" onclick="showTab('live')" id="liveTab">
                <span class="live-indicator" id="liveTabIndicator"></span> Live <span id="liveCount"></span>
            </button>
            <button class="suggestions-tab active" onclick="showTab('history')">History</button>
            <button class="suggestions-tab" onclick="showTab('suggestions')" id="suggestionsTab">
                Suggestions <span id="suggestionsCount"></span>
            </button>
        </div>

        <div class="live-panel" id="livePanel">
            <div class="live-header">
                <div class="live-title">
                    <span class="live-indicator" id="liveIndicator"></span>
                    Live Monitor
                </div>
                <button class="live-settings-btn" onclick="openNotificationSettings()">
                    Settings
                </button>
            </div>

            <div class="live-alert-banner" id="liveAlertBanner">
                <div class="live-alert-content">
                    <span class="live-alert-icon">ðŸ””</span>
                    <span class="live-alert-text" id="liveAlertText">1 session waiting for input</span>
                </div>
                <button class="live-alert-dismiss" onclick="dismissAlert()">&times;</button>
            </div>

            <div class="live-stats">
                <div class="live-stat">
                    <div class="live-stat-value waiting" id="waitingCount">0</div>
                    <div class="live-stat-label">Waiting</div>
                </div>
                <div class="live-stat">
                    <div class="live-stat-value processing" id="processingCount">0</div>
                    <div class="live-stat-label">Processing</div>
                </div>
                <div class="live-stat">
                    <div class="live-stat-value" id="activeCount">0</div>
                    <div class="live-stat-label">Active Sessions</div>
                </div>
            </div>

            <div class="live-sessions" id="liveSessions">
                <!-- Sessions will be populated by JS -->
            </div>

            <div class="live-section-divider" style="margin: 24px 0; border-top: 1px solid var(--border-color);"></div>

            <div class="live-header" style="margin-bottom: 16px;">
                <div class="live-title">
                    Terminal Windows
                    <span id="terminalWindowCount" style="font-size: 14px; color: var(--text-secondary); font-weight: normal;"></span>
                </div>
            </div>

            <div class="live-sessions" id="terminalWindows">
                <!-- Terminal windows will be populated by JS -->
            </div>
        </div>

        <!-- Notification Settings Modal -->
        <div class="modal-overlay" id="notificationModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">Notification Settings</div>
                    <button class="modal-close" onclick="closeNotificationSettings()">&times;</button>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Alert When Session Is Waiting For</div>
                    <label class="modal-checkbox">
                        <input type="checkbox" id="notifyToolApproval" checked>
                        Tool approval (Bash, Write, etc.)
                    </label>
                    <label class="modal-checkbox">
                        <input type="checkbox" id="notifyUserInput" checked>
                        Any user input
                    </label>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Notification Methods</div>
                    <label class="modal-checkbox">
                        <input type="checkbox" id="notifySound" checked>
                        Sound alert
                    </label>
                    <div class="modal-slider-group" id="volumeGroup">
                        <div class="modal-slider-label">Volume: <span id="volumeValue">80</span>%</div>
                        <input type="range" class="modal-slider" id="volumeSlider" min="0" max="100" value="80">
                    </div>

                    <label class="modal-checkbox">
                        <input type="checkbox" id="notifyBrowser" checked>
                        Browser notification
                    </label>

                    <label class="modal-checkbox">
                        <input type="checkbox" id="notifyVisual" checked>
                        Visual pulse indicator
                    </label>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Timing</div>
                    <label class="modal-checkbox">
                        Poll interval: <input type="number" id="pollInterval" value="3" min="1" max="30" style="width: 60px; margin-left: 8px; padding: 4px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);"> seconds
                    </label>
                    <label class="modal-checkbox" style="margin-top: 8px;">
                        Alert cooldown: <input type="number" id="alertCooldown" value="30" min="5" max="300" style="width: 60px; margin-left: 8px; padding: 4px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);"> seconds
                    </label>
                    <label class="modal-checkbox" style="margin-top: 8px;">
                        Waiting delay: <input type="number" id="waitingDelay" value="20" min="0" max="120" style="width: 60px; margin-left: 8px; padding: 4px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);"> seconds
                        <span style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px; margin-left: 0;">Only alert after waiting this long (0 = immediate)</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn modal-btn-test" onclick="testNotification()">Test Alert</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeNotificationSettings()">Cancel</button>
                    <button class="modal-btn modal-btn-primary" onclick="saveNotificationSettings()">Save</button>
                </div>
            </div>
        </div>

        <div class="suggestions-panel" id="suggestionsPanel">
            <!-- Suggestions will be populated by JS -->
        </div>

        <div class="main-content" id="historyPanel">
            <aside class="sidebar">
                <h2>Projects</h2>
                <ul class="project-list" id="projectList">
                    <!-- Projects will be populated by JS -->
                </ul>
            </aside>

            <main class="content-area" id="contentArea">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Global state
        let historyData = null;
        let selectedProject = null;
        let searchQuery = '';
        let dateFrom = null;
        let dateTo = null;

        // Load data
        async function loadData() {
            try {
                const response = await fetch('history_data.json');
                if (!response.ok) throw new Error('Failed to load data');
                historyData = await response.json();
                initializeUI();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        <p>Could not load history data.</p>
                        <p style="font-size: 12px; margin-top: 8px;">Make sure history_data.json exists in the same directory.</p>
                    </div>
                `;
            }
        }

        function initializeUI() {
            renderStats();
            renderProjectList();
            updateSuggestionsCount();

            // Select last used project, or first project if none saved
            const projects = Object.keys(historyData.projects);
            if (projects.length > 0) {
                const lastProject = localStorage.getItem('lastSelectedProject');
                if (lastProject && projects.includes(lastProject)) {
                    selectProject(lastProject);
                } else {
                    selectProject(projects[0]);
                }
            }

            // Set up event listeners
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                if (selectedProject) renderProjectContent(selectedProject);
            });

            document.getElementById('dateFrom').addEventListener('change', (e) => {
                dateFrom = e.target.value ? new Date(e.target.value) : null;
                if (selectedProject) renderProjectContent(selectedProject);
            });

            document.getElementById('dateTo').addEventListener('change', (e) => {
                dateTo = e.target.value ? new Date(e.target.value + 'T23:59:59') : null;
                if (selectedProject) renderProjectContent(selectedProject);
            });
        }

        function renderStats() {
            const projects = Object.values(historyData.projects);
            const totalProjects = projects.length;
            let totalSessions = 0;
            let totalCommits = 0;
            let totalDays = new Set();

            projects.forEach(project => {
                Object.entries(project.days || {}).forEach(([date, day]) => {
                    totalDays.add(date);
                    totalSessions += (day.sessions || []).length;
                    (day.sessions || []).forEach(session => {
                        totalCommits += (session.commits || []).length;
                    });
                });
            });

            // Count beads issues
            let totalBeadsOpen = 0;
            let totalBeadsClosed = 0;
            projects.forEach(project => {
                if (project.beads && project.beads.stats) {
                    totalBeadsOpen += project.beads.stats.open || 0;
                    totalBeadsClosed += project.beads.stats.closed || 0;
                }
            });
            const totalBeads = totalBeadsOpen + totalBeadsClosed;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalProjects}</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDays.size}</div>
                    <div class="stat-label">Active Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalSessions}</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalCommits}</div>
                    <div class="stat-label">Commits</div>
                </div>
                ${totalBeads > 0 ? `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent-orange)">${totalBeadsOpen}</div>
                    <div class="stat-label">Open Issues</div>
                </div>
                ` : ''}
            `;
        }

        function renderProjectList() {
            const projectList = document.getElementById('projectList');
            const projects = Object.entries(historyData.projects)
                .map(([path, data]) => ({
                    path,
                    name: data.name,
                    sessionCount: Object.values(data.days || {})
                        .reduce((sum, day) => sum + (day.sessions || []).length, 0)
                }))
                .sort((a, b) => b.sessionCount - a.sessionCount);

            projectList.innerHTML = projects.map(project => `
                <li class="project-item ${selectedProject === project.path ? 'active' : ''}"
                    onclick="selectProject('${escapeHtml(project.path)}')">
                    <span class="project-name" title="${escapeHtml(project.path)}">${escapeHtml(project.name)}</span>
                    <span class="project-count">${project.sessionCount}</span>
                </li>
            `).join('');
        }

        function selectProject(projectPath) {
            selectedProject = projectPath;
            localStorage.setItem('lastSelectedProject', projectPath);
            renderProjectList();
            renderProjectContent(projectPath);
        }

        function renderProjectContent(projectPath) {
            const project = historyData.projects[projectPath];
            if (!project) return;

            const contentArea = document.getElementById('contentArea');

            // Sort days in reverse chronological order
            const days = Object.entries(project.days || {})
                .sort((a, b) => b[0].localeCompare(a[0]))
                .filter(([date, day]) => {
                    // Date filter
                    const dayDate = new Date(date);
                    if (dateFrom && dayDate < dateFrom) return false;
                    if (dateTo && dayDate > dateTo) return false;
                    return true;
                });

            // Filter by search query
            const filteredDays = days.map(([date, day]) => {
                if (!searchQuery) return [date, day];

                const filteredSessions = (day.sessions || []).filter(session => {
                    const summaryMatch = (session.summary || '').toLowerCase().includes(searchQuery);
                    const commitMatch = (session.commits || []).some(c =>
                        c.message.toLowerCase().includes(searchQuery)
                    );
                    return summaryMatch || commitMatch;
                });

                return [date, { ...day, sessions: filteredSessions }];
            }).filter(([date, day]) => day.sessions.length > 0);

            const githubLink = project.github_url
                ? `<a href="${project.github_url}" target="_blank" class="github-link">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    View on GitHub
                   </a>`
                : '';

            if (filteredDays.length === 0) {
                contentArea.innerHTML = `
                    <div class="content-header">
                        <h2 class="content-title">${escapeHtml(project.name)}</h2>
                        ${githubLink}
                    </div>
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <p>No matching activities found.</p>
                    </div>
                `;
                return;
            }

            contentArea.innerHTML = `
                <div class="content-header">
                    <h2 class="content-title">${escapeHtml(project.name)}</h2>
                    ${githubLink}
                </div>
                <div class="timeline">
                    ${renderBeadsSection(project.beads)}
                    ${filteredDays.map(([date, day]) => renderDay(date, day)).join('')}
                </div>
            `;
        }

        function renderDay(date, day) {
            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return `
                <div class="day-group">
                    <div class="day-header">
                        <span class="day-date">${formattedDate}</span>
                        ${day.summary ? `<span class="day-summary">${highlightSearch(escapeHtml(day.summary.substring(0, 100)))}</span>` : ''}
                    </div>
                    ${(day.sessions || []).map(renderSession).join('')}
                </div>
            `;
        }

        function renderSession(session) {
            const startTime = session.start_time
                ? new Date(session.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                : '';
            const endTime = session.end_time
                ? new Date(session.end_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                : '';
            const timeRange = startTime && endTime ? `${startTime} - ${endTime}` : startTime || '';

            const commitCount = (session.commits || []).length;
            const messageCount = session.message_count || 0;
            const sessionId = session.session_id || Math.random().toString(36).substr(2, 9);

            // Format summary - handle bullet points
            let formattedSummary = session.summary || 'No summary available';
            formattedSummary = formattedSummary.replace(/^- /gm, 'â€¢ ');

            return `
                <div class="session-card" data-session-id="${sessionId}">
                    <div class="session-header">
                        <span class="session-time">${timeRange}</span>
                        <div class="session-meta">
                            <span class="badge clickable" onclick="toggleMessages('${sessionId}')" id="badge-${sessionId}">${messageCount} messages</span>
                            ${commitCount > 0 ? `<span class="badge commit">${commitCount} commit${commitCount > 1 ? 's' : ''}</span>` : ''}
                        </div>
                    </div>
                    <div class="session-summary">${highlightSearch(escapeHtml(formattedSummary))}</div>
                    ${renderMessages(session.messages, sessionId)}
                    ${renderCommits(session.commits)}
                    ${renderTools(session.tools_used)}
                </div>
            `;
        }

        function toggleMessages(sessionId) {
            const messagesList = document.getElementById(`messages-${sessionId}`);
            const badge = document.getElementById(`badge-${sessionId}`);
            if (messagesList) {
                messagesList.classList.toggle('expanded');
                badge.classList.toggle('expanded');
            }
        }

        function renderMessages(messages, sessionId) {
            if (!messages || messages.length === 0) return '';

            return `
                <div class="messages-list" id="messages-${sessionId}">
                    <div class="messages-title">User Messages</div>
                    ${messages.map(msg => {
                        const time = msg.timestamp
                            ? new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                            : '';
                        return `
                            <div class="message-item">
                                ${time ? `<div class="message-time">${time}</div>` : ''}
                                <div class="message-content">${highlightSearch(escapeHtml(msg.content))}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCommits(commits) {
            if (!commits || commits.length === 0) return '';

            return `
                <div class="commits-list">
                    <div class="commits-title">Commits</div>
                    ${commits.map(commit => {
                        const label = commit.tag
                            ? `<span class="tag-icon">ðŸ·ï¸</span> ${escapeHtml(commit.tag)}`
                            : commit.sha.substring(0, 7);
                        const className = commit.tag ? 'commit-tag' : 'commit-sha';
                        return `
                            <div class="commit-item">
                                ${commit.url
                                    ? `<a href="${commit.url}" target="_blank" class="${className}">${label}</a>`
                                    : `<span class="${className}">${label}</span>`
                                }
                                <span class="commit-message">${highlightSearch(escapeHtml(commit.message))}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderTools(tools) {
            if (!tools || tools.length === 0) return '';

            return `
                <div class="tools-list">
                    ${tools.slice(0, 10).map(tool => `
                        <span class="tool-badge">${escapeHtml(tool)}</span>
                    `).join('')}
                    ${tools.length > 10 ? `<span class="tool-badge">+${tools.length - 10} more</span>` : ''}
                </div>
            `;
        }

        // Beads state
        let beadsFilter = 'all';
        let beadsExpanded = false;

        function renderBeadsSection(beads) {
            if (!beads || !beads.issues || beads.issues.length === 0) return '';

            const stats = beads.stats || {};
            const openCount = stats.open || 0;
            const closedCount = stats.closed || 0;

            return `
                <div class="beads-section">
                    <div class="beads-header ${beadsExpanded ? 'expanded' : ''}" onclick="toggleBeads()">
                        <div class="beads-title">
                            <span class="beads-icon">ðŸ”®</span>
                            Beads Issues
                        </div>
                        <div class="beads-stats-mini">
                            <span class="beads-stat-mini"><strong>${openCount}</strong> open</span>
                            <span class="beads-stat-mini"><strong>${closedCount}</strong> closed</span>
                            <span class="beads-toggle">â–¼</span>
                        </div>
                    </div>
                    <div class="beads-content ${beadsExpanded ? 'expanded' : ''}" id="beadsContent">
                        <div class="beads-filters">
                            <button class="beads-filter-btn ${beadsFilter === 'all' ? 'active' : ''}" onclick="filterBeads('all')">All (${beads.issues.length})</button>
                            <button class="beads-filter-btn ${beadsFilter === 'open' ? 'active' : ''}" onclick="filterBeads('open')">Open (${openCount})</button>
                            <button class="beads-filter-btn ${beadsFilter === 'closed' ? 'active' : ''}" onclick="filterBeads('closed')">Closed (${closedCount})</button>
                            ${stats.by_type?.bug ? `<button class="beads-filter-btn ${beadsFilter === 'bug' ? 'active' : ''}" onclick="filterBeads('bug')">Bugs (${stats.by_type.bug})</button>` : ''}
                            ${stats.by_type?.feature ? `<button class="beads-filter-btn ${beadsFilter === 'feature' ? 'active' : ''}" onclick="filterBeads('feature')">Features (${stats.by_type.feature})</button>` : ''}
                            ${stats.by_type?.task ? `<button class="beads-filter-btn ${beadsFilter === 'task' ? 'active' : ''}" onclick="filterBeads('task')">Tasks (${stats.by_type.task})</button>` : ''}
                        </div>
                        <div class="beads-list" id="beadsList">
                            ${renderBeadsList(beads.issues)}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleBeads() {
            beadsExpanded = !beadsExpanded;
            const header = document.querySelector('.beads-header');
            const content = document.getElementById('beadsContent');
            if (header) header.classList.toggle('expanded', beadsExpanded);
            if (content) content.classList.toggle('expanded', beadsExpanded);
        }

        function filterBeads(filter) {
            beadsFilter = filter;
            if (selectedProject) {
                const project = historyData.projects[selectedProject];
                if (project && project.beads) {
                    document.getElementById('beadsList').innerHTML = renderBeadsList(project.beads.issues);
                    // Update active button
                    document.querySelectorAll('.beads-filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.toLowerCase().startsWith(filter)) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
        }

        function renderBeadsList(issues) {
            let filtered = issues;

            if (beadsFilter === 'open') {
                filtered = issues.filter(i => i.status === 'open');
            } else if (beadsFilter === 'closed') {
                filtered = issues.filter(i => i.status === 'closed');
            } else if (beadsFilter === 'bug') {
                filtered = issues.filter(i => i.issue_type === 'bug');
            } else if (beadsFilter === 'feature') {
                filtered = issues.filter(i => i.issue_type === 'feature');
            } else if (beadsFilter === 'task') {
                filtered = issues.filter(i => i.issue_type === 'task');
            }

            // Sort by priority (lower = higher priority), then by updated_at
            filtered.sort((a, b) => {
                if (a.status !== b.status) return a.status === 'open' ? -1 : 1;
                if (a.priority !== b.priority) return (a.priority || 99) - (b.priority || 99);
                return (b.updated_at || '').localeCompare(a.updated_at || '');
            });

            if (filtered.length === 0) {
                return '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No issues match this filter</div>';
            }

            return filtered.map(issue => renderBeadItem(issue)).join('');
        }

        function renderBeadItem(issue) {
            const priorityClass = `priority-${issue.priority || 0}`;
            const statusClass = `status-${issue.status || 'open'}`;

            return `
                <div class="bead-item ${priorityClass} ${statusClass}">
                    <div class="bead-header">
                        <span class="bead-title">${escapeHtml(issue.title)}</span>
                        <span class="bead-id">${escapeHtml(issue.id)}</span>
                    </div>
                    <div class="bead-meta">
                        <span class="bead-type ${issue.issue_type || ''}">${escapeHtml(issue.issue_type || 'unknown')}</span>
                        <span class="bead-status ${issue.status || ''}">${escapeHtml(issue.status || 'open')}</span>
                        ${issue.priority ? `<span class="badge">P${issue.priority}</span>` : ''}
                    </div>
                    ${issue.description ? `<div class="bead-description">${escapeHtml(issue.description.substring(0, 200))}${issue.description.length > 200 ? '...' : ''}</div>` : ''}
                    ${issue.close_reason ? `<div class="bead-close-reason">âœ“ ${escapeHtml(issue.close_reason.substring(0, 200))}${issue.close_reason.length > 200 ? '...' : ''}</div>` : ''}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightSearch(text) {
            if (!searchQuery) return text;
            const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Tab switching
        let currentTab = 'history';

        function showTab(tab) {
            currentTab = tab;
            const historyPanel = document.getElementById('historyPanel');
            const suggestionsPanel = document.getElementById('suggestionsPanel');
            const livePanel = document.getElementById('livePanel');
            const tabs = document.querySelectorAll('.suggestions-tab');

            // Update tab active states
            tabs.forEach((t, i) => {
                const isActive = (i === 0 && tab === 'live') ||
                                 (i === 1 && tab === 'history') ||
                                 (i === 2 && tab === 'suggestions');
                t.classList.toggle('active', isActive);
            });

            // Show/hide panels
            historyPanel.style.display = tab === 'history' ? 'grid' : 'none';
            suggestionsPanel.classList.toggle('active', tab === 'suggestions');
            livePanel.classList.toggle('active', tab === 'live');

            if (tab === 'suggestions') {
                renderSuggestions();
            } else if (tab === 'live') {
                fetchRealtimeData(); // Immediate refresh when switching to live
            }
        }

        // =====================
        // Live Monitor
        // =====================
        let realtimeData = null;
        let pollIntervalId = null;
        let lastAlertTime = 0;
        let alertDismissed = false;
        let previousWaitingProjects = new Set();

        // Notification settings (loaded from localStorage)
        let notificationSettings = JSON.parse(localStorage.getItem('liveNotificationSettings') || JSON.stringify({
            notifyToolApproval: true,
            notifyUserInput: true,
            notifySound: true,
            notifyBrowser: true,
            notifyVisual: true,
            volume: 80,
            pollInterval: 3,
            alertCooldown: 30,
            waitingDelay: 20  // Only alert after waiting this many seconds
        }));

        // Ensure waitingDelay exists for older stored settings
        if (notificationSettings.waitingDelay === undefined) {
            notificationSettings.waitingDelay = 20;
        }

        // Audio context for sound notifications
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playAlertSound() {
            if (!notificationSettings.notifySound) return;

            try {
                const ctx = initAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                oscillator.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, ctx.currentTime + 0.2);

                const volume = notificationSettings.volume / 100 * 0.3;
                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.4);
            } catch (e) {
                console.error('Error playing sound:', e);
            }
        }

        async function showBrowserNotification(title, body) {
            if (!notificationSettings.notifyBrowser) return;

            if (Notification.permission === 'default') {
                await Notification.requestPermission();
            }

            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ””</text></svg>',
                    tag: 'claude-live-alert'
                });
            }
        }

        function updateVisualIndicators(hasWaiting) {
            const liveIndicator = document.getElementById('liveIndicator');
            const liveTabIndicator = document.getElementById('liveTabIndicator');

            if (hasWaiting && notificationSettings.notifyVisual) {
                liveIndicator?.classList.add('alert');
                liveTabIndicator?.classList.add('alert');
            } else {
                liveIndicator?.classList.remove('alert');
                liveTabIndicator?.classList.remove('alert');
            }
        }

        async function fetchRealtimeData() {
            try {
                const response = await fetch('/api/realtime');
                if (!response.ok) throw new Error('Failed to fetch realtime data');
                realtimeData = await response.json();

                renderLivePanel();
                checkForAlerts();

                // Also fetch terminal windows
                fetchTerminalWindows();
            } catch (error) {
                console.error('Error fetching realtime data:', error);
                renderLiveError();
            }
        }

        function checkForAlerts() {
            if (!realtimeData) return;

            const now = Date.now();
            const cooldownMs = notificationSettings.alertCooldown * 1000;
            const waitingDelaySeconds = notificationSettings.waitingDelay || 20;

            // Filter sessions that have been waiting long enough
            const sessionsWaitingLongEnough = (realtimeData.active_sessions || []).filter(s =>
                (s.state === 'waiting_for_approval' || s.state === 'waiting_for_question') &&
                s.idle_seconds >= waitingDelaySeconds
            );

            // Get projects with sessions waiting long enough
            const currentWaitingProjects = new Set(sessionsWaitingLongEnough.map(s => s.project_name));
            const newWaitingProjects = [...currentWaitingProjects].filter(p => !previousWaitingProjects.has(p));

            // Check if we should trigger alerts
            const shouldAlert = newWaitingProjects.length > 0 &&
                               (now - lastAlertTime > cooldownMs) &&
                               !alertDismissed;

            // Check notification type filters (only for sessions waiting long enough)
            const hasApprovalWaiting = sessionsWaitingLongEnough.some(s =>
                s.state === 'waiting_for_approval' && notificationSettings.notifyToolApproval
            );
            const hasQuestionWaiting = sessionsWaitingLongEnough.some(s =>
                s.state === 'waiting_for_question' && notificationSettings.notifyUserInput
            );

            const shouldNotify = hasApprovalWaiting || hasQuestionWaiting;

            if (shouldAlert && shouldNotify) {
                lastAlertTime = now;
                alertDismissed = false;

                // Play sound
                playAlertSound();

                // Show browser notification
                const waitingCount = sessionsWaitingLongEnough.length;
                const projects = newWaitingProjects.join(', ');
                showBrowserNotification(
                    `${waitingCount} session${waitingCount > 1 ? 's' : ''} waiting`,
                    `Projects: ${projects}`
                );

                // Show alert banner
                showAlertBanner();
            }

            // Always update visual indicators (show if any sessions waiting long enough)
            updateVisualIndicators(sessionsWaitingLongEnough.length > 0);

            // Update previous state
            previousWaitingProjects = currentWaitingProjects;
        }

        function showAlertBanner() {
            const banner = document.getElementById('liveAlertBanner');
            const text = document.getElementById('liveAlertText');

            if (realtimeData && banner && text) {
                const count = realtimeData.waiting_count || 0;
                const projects = realtimeData.projects_with_waiting?.join(', ') || '';
                text.textContent = `${count} session${count > 1 ? 's' : ''} waiting for input (${projects})`;
                banner.classList.add('active');
            }
        }

        function dismissAlert() {
            const banner = document.getElementById('liveAlertBanner');
            banner?.classList.remove('active');
            alertDismissed = true;

            // Reset dismissed state after cooldown
            setTimeout(() => {
                alertDismissed = false;
            }, notificationSettings.alertCooldown * 1000);
        }

        function renderLivePanel() {
            if (!realtimeData) return;

            // Update stats
            document.getElementById('waitingCount').textContent = realtimeData.waiting_count || 0;
            document.getElementById('processingCount').textContent = realtimeData.processing_count || 0;
            document.getElementById('activeCount').textContent = realtimeData.active_sessions?.length || 0;

            // Update live count badge
            const liveCount = document.getElementById('liveCount');
            if (liveCount) {
                const waiting = realtimeData.waiting_count || 0;
                liveCount.textContent = waiting > 0 ? `(${waiting})` : '';
            }

            // Update alert banner visibility
            const banner = document.getElementById('liveAlertBanner');
            if (realtimeData.waiting_count === 0) {
                banner?.classList.remove('active');
            }

            // Render sessions
            const sessionsContainer = document.getElementById('liveSessions');
            const sessions = realtimeData.active_sessions || [];

            if (sessions.length === 0) {
                sessionsContainer.innerHTML = `
                    <div class="live-empty">
                        <div class="live-empty-icon">ðŸ’¤</div>
                        <p>No active sessions</p>
                        <p style="font-size: 12px; margin-top: 8px; color: var(--text-muted);">
                            Start a Claude Code session in any project to see it here
                        </p>
                    </div>
                `;
                return;
            }

            sessionsContainer.innerHTML = sessions.map(session => {
                const stateClass = session.state === 'waiting_for_approval' || session.state === 'waiting_for_question' ? 'waiting' :
                                   session.state === 'processing' ? 'processing' :
                                   session.state === 'task_complete' ? 'complete' : 'idle';
                const stateLabel = session.state === 'waiting_for_approval' ? 'Needs Approval' :
                                   session.state === 'waiting_for_question' ? 'Question' :
                                   session.state === 'task_complete' ? 'Ready' :
                                   session.state === 'processing' ? 'Processing' : 'Idle';

                const idleText = session.idle_seconds < 60 ?
                    `${session.idle_seconds}s ago` :
                    `${Math.floor(session.idle_seconds / 60)}m ago`;

                const modelShort = session.model?.includes('opus') ? 'Opus 4.5' :
                                   session.model?.includes('sonnet') ? 'Sonnet' : session.model;

                let approvalHtml = '';
                if (session.pending_approval) {
                    approvalHtml = `
                        <div class="live-session-approval">
                            <div class="live-session-approval-label">Pending: ${session.pending_approval.tool_name}</div>
                            <div>${session.pending_approval.description || ''}</div>
                        </div>
                    `;
                }

                let previewHtml = '';
                if (session.last_message_preview) {
                    previewHtml = `<div class="live-session-preview">"${session.last_message_preview}"</div>`;
                }

                return `
                    <div class="live-session-card ${stateClass}">
                        <div class="live-session-header">
                            <div class="live-session-project">
                                ${session.project_name}
                            </div>
                            <span class="live-session-state ${stateClass}">${stateLabel}</span>
                        </div>
                        <div class="live-session-details">
                            <div class="live-session-detail">
                                <span>ðŸ•</span> ${idleText}
                            </div>
                            ${session.last_tool ? `
                                <div class="live-session-detail">
                                    <span>ðŸ”§</span> ${session.last_tool.name}
                                </div>
                            ` : ''}
                            <div class="live-session-detail">
                                <span>ðŸ¤–</span> ${modelShort}
                            </div>
                        </div>
                        ${previewHtml}
                        ${approvalHtml}
                        <div class="live-session-actions">
                            <button class="live-jump-btn" onclick="jumpToProject('${session.project_name}', '${session.project_path}', this)">
                                â†— Jump to Project
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLiveError() {
            const sessionsContainer = document.getElementById('liveSessions');
            sessionsContainer.innerHTML = `
                <div class="live-empty">
                    <div class="live-empty-icon">âš ï¸</div>
                    <p>Could not connect to server</p>
                    <p style="font-size: 12px; margin-top: 8px; color: var(--text-muted);">
                        Make sure you're running <code>python server.py</code>
                    </p>
                </div>
            `;
        }

        // Terminal Windows
        let terminalWindowsData = null;

        async function fetchTerminalWindows() {
            try {
                const response = await fetch('/api/terminal-windows');
                if (!response.ok) throw new Error('Failed to fetch terminal windows');
                terminalWindowsData = await response.json();
                renderTerminalWindows();
            } catch (error) {
                console.error('Error fetching terminal windows:', error);
            }
        }

        function renderTerminalWindows() {
            if (!terminalWindowsData) return;

            const container = document.getElementById('terminalWindows');
            const countSpan = document.getElementById('terminalWindowCount');

            const windows = terminalWindowsData.windows || [];
            const claudeCount = terminalWindowsData.claude_count || 0;

            if (countSpan) {
                countSpan.textContent = `(${claudeCount} Claude / ${windows.length} total)`;
            }

            if (windows.length === 0) {
                container.innerHTML = `
                    <div class="live-empty" style="padding: 30px;">
                        <p style="color: var(--text-muted);">No Terminal windows open</p>
                    </div>
                `;
                return;
            }

            // Group windows by project name
            const projectGroups = {};
            windows.forEach(win => {
                const projectName = win.project_name || 'Unknown';
                if (!projectGroups[projectName]) {
                    projectGroups[projectName] = {
                        windows: [],
                        hasClaude: false,
                        projectPath: win.project_path
                    };
                }
                projectGroups[projectName].windows.push(win);
                if (win.is_claude) {
                    projectGroups[projectName].hasClaude = true;
                }
            });

            // Sort projects: Claude projects first, then alphabetically
            const sortedProjects = Object.keys(projectGroups).sort((a, b) => {
                const aHasClaude = projectGroups[a].hasClaude;
                const bHasClaude = projectGroups[b].hasClaude;
                if (aHasClaude && !bHasClaude) return -1;
                if (!aHasClaude && bHasClaude) return 1;
                return a.localeCompare(b);
            });

            // Sort windows within each project by window_id for stability
            sortedProjects.forEach(projectName => {
                projectGroups[projectName].windows.sort((a, b) => a.window_id - b.window_id);
            });

            container.innerHTML = sortedProjects.map(projectName => {
                const group = projectGroups[projectName];
                const hasRecentActivity = realtimeData?.active_sessions?.some(
                    s => s.project_name === projectName
                );
                const stateClass = group.hasClaude ? (hasRecentActivity ? 'processing' : 'idle') : 'idle';

                const windowsList = group.windows.map(win => {
                    const isClaude = win.is_claude;
                    // Extract short description from window name (after the project name)
                    let shortDesc = win.window_name;
                    if (shortDesc.includes(' â€” ')) {
                        const parts = shortDesc.split(' â€” ');
                        shortDesc = parts.slice(1).join(' â€” ');
                    }

                    return `
                        <div class="terminal-window-item" style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 6px;">
                            <button class="live-jump-btn" style="font-size: 11px; padding: 4px 10px; flex-shrink: 0;" data-window-id="${win.window_id}" onclick="jumpToWindowById(${win.window_id}, this)">
                                â†— Jump
                            </button>
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                ${isClaude ? '<span style="color: var(--accent-purple); font-size: 10px;">â—</span>' : '<span style="color: var(--text-muted); font-size: 10px;">â—‹</span>'}
                                <span style="font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${shortDesc}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="live-session-card ${stateClass}" style="margin-bottom: 16px;">
                        <div class="live-session-header" style="margin-bottom: 12px;">
                            <div class="live-session-project" style="font-size: 15px; font-weight: 600;">
                                ${projectName}
                                ${group.hasClaude ? '<span style="color: var(--accent-purple); font-size: 11px; margin-left: 8px;">Claude</span>' : ''}
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">
                                ${group.windows.length} window${group.windows.length > 1 ? 's' : ''}
                            </span>
                        </div>
                        <div class="terminal-windows-list">
                            ${windowsList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function jumpToWindowById(windowId, button) {
            console.log('jumpToWindowById called with windowId:', windowId, 'button data-window-id:', button.dataset.windowId);
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'â³ Jumping...';

            try {
                // Use the data attribute as fallback
                const idToUse = windowId || parseInt(button.dataset.windowId);
                console.log('Sending request with window_id:', idToUse);

                const response = await fetch('/api/focus-terminal-by-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ window_id: idToUse })
                });

                const result = await response.json();
                console.log('Server response:', result);

                if (result.success) {
                    button.classList.add('success');
                    button.innerHTML = 'âœ“ Focused!';
                    setTimeout(() => {
                        button.classList.remove('success');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.classList.add('error');
                    button.innerHTML = 'âœ— ' + (result.error || 'Failed');
                    setTimeout(() => {
                        button.classList.remove('error');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 3000);
                }
            } catch (error) {
                button.classList.add('error');
                button.innerHTML = 'âœ— Error';
                setTimeout(() => {
                    button.classList.remove('error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
            }
        }

        async function jumpToProject(projectName, projectPath, button) {
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'â³ Jumping...';

            try {
                const response = await fetch('/api/focus-terminal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_name: projectName,
                        project_path: projectPath
                    })
                });

                const result = await response.json();

                if (result.success) {
                    button.classList.add('success');
                    button.innerHTML = 'âœ“ Focused ' + result.terminal;
                    setTimeout(() => {
                        button.classList.remove('success');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.classList.add('error');
                    button.innerHTML = 'âœ— ' + (result.error || 'Not found');
                    setTimeout(() => {
                        button.classList.remove('error');
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 3000);
                }
            } catch (error) {
                button.classList.add('error');
                button.innerHTML = 'âœ— Error';
                setTimeout(() => {
                    button.classList.remove('error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
            }
        }

        function startPolling() {
            // Clear existing interval
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
            }

            // Start new polling
            const intervalMs = (notificationSettings.pollInterval || 3) * 1000;
            pollIntervalId = setInterval(fetchRealtimeData, intervalMs);

            // Initial fetch
            fetchRealtimeData();
        }

        function stopPolling() {
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
        }

        // Notification Settings Modal
        function openNotificationSettings() {
            const modal = document.getElementById('notificationModal');
            modal.classList.add('active');

            // Load current settings into form
            document.getElementById('notifyToolApproval').checked = notificationSettings.notifyToolApproval;
            document.getElementById('notifyUserInput').checked = notificationSettings.notifyUserInput;
            document.getElementById('notifySound').checked = notificationSettings.notifySound;
            document.getElementById('notifyBrowser').checked = notificationSettings.notifyBrowser;
            document.getElementById('notifyVisual').checked = notificationSettings.notifyVisual;
            document.getElementById('volumeSlider').value = notificationSettings.volume;
            document.getElementById('volumeValue').textContent = notificationSettings.volume;
            document.getElementById('pollInterval').value = notificationSettings.pollInterval;
            document.getElementById('alertCooldown').value = notificationSettings.alertCooldown;
            document.getElementById('waitingDelay').value = notificationSettings.waitingDelay || 20;
        }

        function closeNotificationSettings() {
            const modal = document.getElementById('notificationModal');
            modal.classList.remove('active');
        }

        function saveNotificationSettings() {
            notificationSettings = {
                notifyToolApproval: document.getElementById('notifyToolApproval').checked,
                notifyUserInput: document.getElementById('notifyUserInput').checked,
                notifySound: document.getElementById('notifySound').checked,
                notifyBrowser: document.getElementById('notifyBrowser').checked,
                notifyVisual: document.getElementById('notifyVisual').checked,
                volume: parseInt(document.getElementById('volumeSlider').value),
                pollInterval: parseInt(document.getElementById('pollInterval').value) || 3,
                alertCooldown: parseInt(document.getElementById('alertCooldown').value) || 30,
                waitingDelay: parseInt(document.getElementById('waitingDelay').value) || 20
            };

            localStorage.setItem('liveNotificationSettings', JSON.stringify(notificationSettings));

            // Restart polling with new interval
            startPolling();

            closeNotificationSettings();
        }

        function testNotification() {
            playAlertSound();
            showBrowserNotification('Test Alert', 'This is a test notification from Claude History Analyzer');
        }

        // Volume slider handler
        document.getElementById('volumeSlider')?.addEventListener('input', (e) => {
            document.getElementById('volumeValue').textContent = e.target.value;
        });

        // Close modal on overlay click
        document.getElementById('notificationModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'notificationModal') {
                closeNotificationSettings();
            }
        });

        // Request notification permission on first interaction
        document.addEventListener('click', function requestNotificationPermission() {
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            document.removeEventListener('click', requestNotificationPermission);
        }, { once: true });

        // Start polling when page loads
        startPolling();

        // Suggestions
        let savedSuggestions = JSON.parse(localStorage.getItem('savedSuggestions') || '[]');

        function renderSuggestions() {
            const panel = document.getElementById('suggestionsPanel');
            const suggestions = historyData.suggestions || [];

            if (suggestions.length === 0) {
                panel.innerHTML = `
                    <div class="suggestions-empty">
                        <div class="suggestions-empty-icon">ðŸ’¡</div>
                        <p>No suggestions available yet.</p>
                        <p style="font-size: 12px; margin-top: 8px;">Run the analyzer with API key to generate personalized CLAUDE.md suggestions.</p>
                    </div>
                `;
                return;
            }

            panel.innerHTML = `
                <div class="suggestions-header">
                    <div class="suggestions-title">
                        <span>ðŸ’¡</span> CLAUDE.md Suggestions
                    </div>
                    <div class="suggestions-subtitle">
                        Personalized instructions based on your coding patterns and best practices.
                        Click "Add to CLAUDE.md" to save any suggestion.
                    </div>
                </div>
                <div class="suggestions-list">
                    ${suggestions.map((s, i) => renderSuggestionCard(s, i)).join('')}
                </div>
                <div class="claude-md-status" id="claudeMdStatus">
                    Loading CLAUDE.md status...
                </div>
            `;

            // Check CLAUDE.md status
            checkClaudeMdStatus();
        }

        function renderSuggestionCard(suggestion, index) {
            const isSaved = savedSuggestions.includes(suggestion.instruction);

            return `
                <div class="suggestion-card ${isSaved ? 'saved' : ''}" id="suggestion-${index}">
                    <div class="suggestion-header">
                        <span class="suggestion-title">${escapeHtml(suggestion.title)}</span>
                        <button
                            class="suggestion-save-btn"
                            onclick="saveInstruction(${index})"
                            ${isSaved ? 'disabled' : ''}
                        >
                            ${isSaved ? 'âœ“ Added' : '+ Add to CLAUDE.md'}
                        </button>
                    </div>
                    <div class="suggestion-instruction">${escapeHtml(suggestion.instruction)}</div>
                    <div class="suggestion-rationale">${escapeHtml(suggestion.rationale)}</div>
                </div>
            `;
        }

        async function saveInstruction(index) {
            const suggestion = historyData.suggestions[index];
            if (!suggestion) return;

            const btn = document.querySelector(`#suggestion-${index} .suggestion-save-btn`);
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/add-instruction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: suggestion.title,
                        instruction: suggestion.instruction
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Mark as saved
                    savedSuggestions.push(suggestion.instruction);
                    localStorage.setItem('savedSuggestions', JSON.stringify(savedSuggestions));

                    btn.textContent = 'âœ“ Added';
                    document.querySelector(`#suggestion-${index}`).classList.add('saved');

                    // Update status
                    checkClaudeMdStatus();
                } else {
                    btn.textContent = result.message || 'Already exists';
                    setTimeout(() => {
                        btn.textContent = '+ Add to CLAUDE.md';
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to save instruction:', error);
                btn.textContent = 'Error - Try again';
                setTimeout(() => {
                    btn.textContent = '+ Add to CLAUDE.md';
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function checkClaudeMdStatus() {
            const statusDiv = document.getElementById('claudeMdStatus');
            if (!statusDiv) return;

            try {
                const response = await fetch('/api/claude-md');
                const data = await response.json();

                if (data.exists) {
                    const lineCount = (data.content.match(/\n/g) || []).length + 1;
                    statusDiv.innerHTML = `
                        ðŸ“„ CLAUDE.md: <span class="claude-md-path">${escapeHtml(data.path)}</span>
                        <br>Currently ${lineCount} lines
                    `;
                } else {
                    statusDiv.innerHTML = `
                        ðŸ“„ CLAUDE.md will be created at: <span class="claude-md-path">${escapeHtml(data.path)}</span>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    âš ï¸ Could not check CLAUDE.md status. Make sure you're running <code>python server.py</code>
                `;
            }
        }

        function updateSuggestionsCount() {
            const count = (historyData.suggestions || []).length;
            const countSpan = document.getElementById('suggestionsCount');
            if (countSpan && count > 0) {
                countSpan.textContent = `(${count})`;
            }
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
